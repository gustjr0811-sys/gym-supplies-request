name: Keep Streamlit App Awake

on:
  schedule:
    # 10ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€: 0ì‹œ, 10ì‹œ, 20ì‹œ)
    - cron: '0 0,10,20 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Wake up Streamlit app
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          python - <<'EOF'
          import os
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from webdriver_manager.chrome import ChromeDriverManager

          # Streamlit ì•± URL ê°€ì ¸ì˜¤ê¸°
          app_url = os.environ.get('STREAMLIT_APP_URL')
          if not app_url:
              print("âŒ Error: STREAMLIT_APP_URL not set in GitHub Secrets")
              exit(1)

          print(f"ğŸš€ Visiting Streamlit app: {app_url}")

          # Chrome ì˜µì…˜ ì„¤ì • (í—¤ë“œë¦¬ìŠ¤ ëª¨ë“œ)
          chrome_options = Options()
          chrome_options.add_argument('--headless')
          chrome_options.add_argument('--no-sandbox')
          chrome_options.add_argument('--disable-dev-shm-usage')
          chrome_options.add_argument('--disable-gpu')

          # Chrome ë“œë¼ì´ë²„ ì„¤ì •
          service = Service(ChromeDriverManager().install())
          driver = webdriver.Chrome(service=service, options=chrome_options)

          try:
              # Streamlit ì•± ë°©ë¬¸
              driver.get(app_url)
              print("âœ… Successfully loaded the page")

              # í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
              time.sleep(5)

              # "Yes, get this app back up!" ë²„íŠ¼ ì°¾ê¸° ì‹œë„
              try:
                  wake_button = WebDriverWait(driver, 10).until(
                      EC.presence_of_element_located((By.XPATH, "//*[contains(text(), 'Yes, get this app back up')]"))
                  )
                  print("ğŸ˜´ App is sleeping. Clicking wake button...")
                  wake_button.click()
                  time.sleep(5)
                  print("âœ… Wake button clicked! App should be awake now.")
              except:
                  print("âœ… App is already awake (no sleep button found)")

              # ì•±ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
              time.sleep(3)
              print("ğŸ‰ Keep-alive task completed successfully!")

          except Exception as e:
              print(f"âŒ Error: {str(e)}")
              raise
          finally:
              driver.quit()
          EOF

      - name: Report status
        if: always()
        run: |
          echo "Keep-alive job finished at $(date)"
